<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planejador Financeiro Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Configura√ß√£o do Tailwind para usar a fonte correta -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Segoe UI', 'Arial', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- Import Map: Ensina o navegador onde buscar os pacotes React e Recharts -->
    <!-- FIX: Adicionado "react-dom" para resolver depend√™ncias internas de bibliotecas -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom": "https://esm.sh/react-dom@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "recharts": "https://esm.sh/recharts@2.12.0?external=react,react-dom",
            "lucide-react": "https://esm.sh/lucide-react@0.330.0?external=react"
        }
    }
    </script>

    <!-- Babel Standalone: Permite rodar JSX (c√≥digo React) direto no navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* Estilos extras para garantir visualiza√ß√£o limpa */
        body { -webkit-font-smoothing: antialiased; }
        .recharts-wrapper { margin: 0 auto; }
    </style>
</head>
<body class="bg-slate-50">
    
    <!-- Onde o React vai montar o app -->
    <div id="root"></div>

    <!-- Seu C√≥digo React (Tipo "text/babel" para ser processado) -->
    <script type="text/babel" data-type="module">
        import React, { useState, useMemo, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, AreaChart, Area, ReferenceLine } from 'recharts';
        import { Calculator, TrendingUp, TrendingDown, DollarSign, Calendar, ShieldCheck, AlertCircle, ChevronDown, ChevronUp, Activity, AlertTriangle, Zap, Home, Lock } from 'lucide-react';

        // --- COMPONENTES UI ---

        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-xl shadow-sm border border-gray-100 p-6 ${className}`}>
                {children}
            </div>
        );

        const InputGroup = ({ label, icon: Icon, value, onChange, prefix = "R$ ", type = "currency", suffix = "", helpText = "" }) => {
            const handleChange = (e) => {
                let val = e.target.value;
                if (type === "currency") {
                    val = val.replace(/\D/g, "");
                    onChange(val); 
                } else {
                    onChange(val);
                }
            };

            const displayValue = () => {
                if (type === "currency") {
                    if (!value) return "";
                    return (parseInt(value) / 100).toLocaleString("pt-BR", { minimumFractionDigits: 2 });
                }
                return value;
            };

            return (
                <div className="mb-4">
                    <label className="block text-sm font-medium text-gray-700 mb-1 flex justify-between items-center">
                        {label}
                    </label>
                    <div className="relative rounded-md shadow-sm group">
                        <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <Icon className="h-5 w-5 text-gray-400" />
                        </div>
                        <input
                            type={type === "number" ? "number" : "text"}
                            value={displayValue()}
                            onChange={handleChange}
                            className="block w-full pl-10 pr-12 py-3 border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm border transition-colors"
                            placeholder="0,00"
                        />
                        <div className="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                            <span className="text-gray-500 sm:text-sm">{suffix}</span>
                        </div>
                    </div>
                    {helpText && <p className="text-xs text-slate-500 mt-1">{helpText}</p>}
                </div>
            );
        };

        // --- COMPONENTE PRINCIPAL ---

        function FinancialPlanner() {
            // --- STATE ---
            const [inputs, setInputs] = useState({
                patrimonio: "0", // Liquidez imediata
                aporte: "150000", 
                anosAcumulacao: 20,
                saque: "400000", 
                anosUsufruto: 30,
                retornoAno: 8, 
                inflacao: 4, 
                margemSeguranca: 20, 
                considerarInflacao: false,
                
                // Novos Campos
                patrimonioImobilizado: "0", // Casa, Carro (N√£o rende, n√£o saca)
                patrimonioRestrito: "0" // FGTS, Prev (Rende, saca na aposentadoria)
            });

            const [showDetails, setShowDetails] = useState(false);
            const [activeTab, setActiveTab] = useState('simulacao'); // 'simulacao' | 'risco'

            // Load from local storage on mount
            useEffect(() => {
                const saved = localStorage.getItem('financial_plan_v4'); // V4 update
                if (saved) {
                    try {
                        setInputs(prev => ({ ...prev, ...JSON.parse(saved) }));
                    } catch (e) { console.error("Error loading save", e); }
                }
            }, []);

            // Save to local storage on change
            useEffect(() => {
                localStorage.setItem('financial_plan_v4', JSON.stringify(inputs));
            }, [inputs]);

            const updateInput = (field, value) => {
                setInputs(prev => ({ ...prev, [field]: value }));
            };

            // --- ENGINE DE C√ÅLCULO UNIFICADA ---
            const results = useMemo(() => {
                // 1. Parse inputs
                const patrimonioLiquidoInicial = parseInt(inputs.patrimonio || "0") / 100;
                const aporteMensal = parseInt(inputs.aporte || "0") / 100;
                const saqueMensal = parseInt(inputs.saque || "0") / 100;
                const imobilizado = parseInt(inputs.patrimonioImobilizado || "0") / 100;
                const restritoInicial = parseInt(inputs.patrimonioRestrito || "0") / 100;

                const taxaRetorno = parseFloat(inputs.retornoAno) / 100;
                const taxaInflacao = parseFloat(inputs.inflacao) / 100;
                
                // Taxa Efetiva
                let taxaMensalEfetiva;
                if (inputs.considerarInflacao) {
                    const taxaReal = ((1 + taxaRetorno) / (1 + taxaInflacao)) - 1;
                    taxaMensalEfetiva = Math.pow(1 + taxaReal, 1/12) - 1;
                } else {
                    taxaMensalEfetiva = Math.pow(1 + taxaRetorno, 1/12) - 1;
                }

                const mesesAcumulacao = inputs.anosAcumulacao * 12;
                const mesesUsufruto = inputs.anosUsufruto * 12;
                const totalMeses = mesesAcumulacao + mesesUsufruto;

                // --- SIMULA√á√ÉO PRINCIPAL ---
                let saldoLiquido = patrimonioLiquidoInicial;
                // O saldo restrito (FGTS/Prev) rende separado at√© a aposentadoria
                // Vamos assumir que ele rende a mesma taxa da carteira (cen√°rio neutro)
                let saldoRestrito = restritoInicial; 

                let dadosGrafico = [];
                let mesFimDinheiro = null;

                for (let m = 1; m <= totalMeses; m++) {
                    const isAcumulacao = m <= mesesAcumulacao;
                    const ano = Math.floor(m / 12);
                    
                    // 1. Render Investimentos
                    saldoLiquido = saldoLiquido * (1 + taxaMensalEfetiva);

                    if (isAcumulacao) {
                        // Fase Acumula√ß√£o: Aporta e FGTS rende separado
                        saldoLiquido += aporteMensal;
                        saldoRestrito = saldoRestrito * (1 + taxaMensalEfetiva);
                    } else {
                        // Fase Usufruto:
                        // No primeiro m√™s da aposentadoria (m = mesesAcumulacao + 1), 
                        // o FGTS/Prev vira liquidez.
                        if (m === mesesAcumulacao + 1) {
                            saldoLiquido += saldoRestrito;
                            saldoRestrito = 0; // Zerar pois j√° foi transferido
                        }
                        
                        saldoLiquido -= saqueMensal;
                    }

                    // Verifica fal√™ncia (apenas da parte l√≠quida)
                    if (saldoLiquido < 0) {
                        if (mesFimDinheiro === null) mesFimDinheiro = m;
                        saldoLiquido = 0;
                    }

                    if (m % 12 === 0 || m === totalMeses || m === mesesAcumulacao) {
                        dadosGrafico.push({
                            ano: ano,
                            mes: m,
                            saldoLiquido: Math.round(saldoLiquido),
                            saldoRestrito: Math.round(isAcumulacao ? saldoRestrito : 0),
                            saldoImobilizado: Math.round(imobilizado), // Constante em valor real
                            saldoTotal: Math.round(saldoLiquido + (isAcumulacao ? saldoRestrito : 0) + imobilizado),
                            fase: isAcumulacao ? "Acumula√ß√£o" : "Usufruto"
                        });
                    }
                }

                // --- C√ÅLCULO DE KPIS ---
                const i = taxaMensalEfetiva;
                const n = mesesUsufruto;
                const montanteMatematico = i > 0 
                    ? saqueMensal * (1 - Math.pow(1 + i, -n)) / i 
                    : saqueMensal * n;

                const montanteNecessario = montanteMatematico * (1 + (inputs.margemSeguranca / 100));
                
                // O Saldo final da acumula√ß√£o inclui a inje√ß√£o do FGTS/Prev que acontece na virada
                const saldoFinalAcumulacao = dadosGrafico.find(d => d.mes === mesesAcumulacao)?.saldoTotal - imobilizado || 0;
                
                const sucesso = saldoFinalAcumulacao >= montanteNecessario;
                const durouTudo = mesFimDinheiro === null;

                // --- SIMULA√á√ÉO DE CRISE ---
                // Aplica queda de 30% sobre o saldo L√çQUIDO+RESTRITO no momento da aposentadoria
                let saldoCrise = saldoFinalAcumulacao * 0.7; 
                let sobreviveuCrise = true;
                for (let m = 1; m <= mesesUsufruto; m++) {
                    saldoCrise = saldoCrise * (1 + taxaMensalEfetiva) - saqueMensal;
                    if (saldoCrise <= 0) {
                        sobreviveuCrise = false;
                        break;
                    }
                }

                // --- MONTE CARLO (RISCO) ---
                const simulacoes = 500;
                let falhas = 0;
                
                for (let s = 0; s < simulacoes; s++) {
                    let p = patrimonioLiquidoInicial;
                    let pRestrito = restritoInicial;
                    
                    // Fase Acumula√ß√£o
                    for (let y = 1; y <= inputs.anosAcumulacao; y++) {
                        const variacao = (Math.random() - 0.5) * 0.2; 
                        const r = taxaRetorno + variacao;
                        let taxaSimulada = inputs.considerarInflacao ? ((1 + r) / (1 + taxaInflacao)) - 1 : r;

                        p = p * (1 + taxaSimulada) + (aporteMensal * 12);
                        pRestrito = pRestrito * (1 + taxaSimulada);
                    }

                    // Inje√ß√£o do Restrito
                    p += pRestrito;

                    // Fase Usufruto
                    for (let y = 1; y <= inputs.anosUsufruto; y++) {
                        const variacao = (Math.random() - 0.5) * 0.2;
                        const r = taxaRetorno + variacao;
                        let taxaSimulada = inputs.considerarInflacao ? ((1 + r) / (1 + taxaInflacao)) - 1 : r;

                        p = p * (1 + taxaSimulada) - (saqueMensal * 12);

                        if (p <= 0) {
                            falhas++;
                            break;
                        }
                    }
                }
                const riscoRuina = (falhas / simulacoes) * 100;

                return {
                    dadosGrafico,
                    saldoFinalAcumulacao,
                    montanteNecessario,
                    sucesso,
                    durouTudo,
                    mesFimDinheiro,
                    saldoFinalTotal: dadosGrafico[dadosGrafico.length - 1].saldoTotal,
                    sobreviveuCrise,
                    riscoRuina,
                    imobilizado
                };

            }, [inputs]);

            const formatMoney = (val) => val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

            return (
                <div className="min-h-screen pb-10">
                    
                    {/* HEADER */}
                    <div className="bg-emerald-600 text-white py-8 shadow-lg">
                        <div className="max-w-6xl mx-auto px-4">
                            <h1 className="text-3xl font-bold flex items-center gap-3">
                                <Calculator className="h-8 w-8" />
                                Simulador de Independ√™ncia Financeira
                            </h1>
                            <p className="opacity-90 mt-2">Planeje seu futuro com precis√£o matem√°tica.</p>
                        </div>
                    </div>

                    <div className="max-w-6xl mx-auto px-4 mt-8 grid grid-cols-1 lg:grid-cols-12 gap-8">
                        
                        {/* LEFT COLUMN: INPUTS */}
                        <div className="lg:col-span-4 space-y-6">
                            
                            {/* ACUMULA√á√ÉO */}
                            <Card>
                                <h2 className="text-xl font-bold mb-4 flex items-center gap-2 text-emerald-700">
                                    <TrendingUp className="h-5 w-5" />
                                    Fase de Acumula√ß√£o
                                </h2>
                                <InputGroup 
                                    label="Investimentos L√≠quidos" 
                                    icon={DollarSign} 
                                    value={inputs.patrimonio} 
                                    onChange={v => updateInput("patrimonio", v)} 
                                    helpText="Dinheiro dispon√≠vel hoje em corretoras/bancos."
                                />
                                <InputGroup 
                                    label="Aporte Mensal" 
                                    icon={TrendingUp} 
                                    value={inputs.aporte} 
                                    onChange={v => updateInput("aporte", v)} 
                                />
                                <InputGroup 
                                    label="Anos Acumulando" 
                                    icon={Calendar} 
                                    type="number"
                                    prefix=""
                                    suffix="anos"
                                    value={inputs.anosAcumulacao} 
                                    onChange={v => updateInput("anosAcumulacao", v)} 
                                />
                            </Card>

                            {/* OUTROS ATIVOS (NOVO) */}
                            <Card>
                                <h2 className="text-xl font-bold mb-4 flex items-center gap-2 text-blue-700">
                                    <Home className="h-5 w-5" />
                                    Outros Ativos
                                </h2>
                                <InputGroup 
                                    label="FGTS / Previd√™ncia" 
                                    icon={Lock} 
                                    value={inputs.patrimonioRestrito} 
                                    onChange={v => updateInput("patrimonioRestrito", v)} 
                                    helpText="Valores que rendem juros, mas s√≥ ficam dispon√≠veis na aposentadoria."
                                />
                                <InputGroup 
                                    label="Bens (Casa, Carro)" 
                                    icon={Home} 
                                    value={inputs.patrimonioImobilizado} 
                                    onChange={v => updateInput("patrimonioImobilizado", v)} 
                                    helpText="Patrim√¥nio que comp√µe riqueza, mas N√ÉO gera renda mensal."
                                />
                            </Card>

                            {/* USUFRUTO */}
                            <Card>
                                <h2 className="text-xl font-bold mb-4 flex items-center gap-2 text-orange-600">
                                    <TrendingDown className="h-5 w-5" />
                                    Fase de Usufruto
                                </h2>
                                <InputGroup 
                                    label="Saque Mensal Desejado" 
                                    icon={DollarSign} 
                                    value={inputs.saque} 
                                    onChange={v => updateInput("saque", v)} 
                                    helpText="Valor em poder de compra de hoje."
                                />
                                <InputGroup 
                                    label="Dura√ß√£o da Aposentadoria" 
                                    icon={Calendar} 
                                    type="number"
                                    prefix=""
                                    suffix="anos"
                                    value={inputs.anosUsufruto} 
                                    onChange={v => updateInput("anosUsufruto", v)} 
                                />
                            </Card>

                            {/* PREMISSAS */}
                            <Card>
                                <h2 className="text-xl font-bold mb-4 flex items-center gap-2 text-slate-700">
                                    <ShieldCheck className="h-5 w-5" />
                                    Premissas
                                </h2>
                                <div className="grid grid-cols-2 gap-4">
                                    <InputGroup 
                                    label="Retorno Anual" 
                                    icon={TrendingUp} 
                                    type="number"
                                    prefix=""
                                    suffix="%"
                                    value={inputs.retornoAno} 
                                    onChange={v => updateInput("retornoAno", v)} 
                                    />
                                    <InputGroup 
                                    label="Margem Seg." 
                                    icon={ShieldCheck} 
                                    type="number"
                                    prefix=""
                                    suffix="%"
                                    value={inputs.margemSeguranca} 
                                    onChange={v => updateInput("margemSeguranca", v)} 
                                    />
                                </div>
                                
                                <div className="mt-4 p-3 bg-slate-100 rounded-lg">
                                    <label className="flex items-center gap-2 cursor-pointer">
                                        <input 
                                            type="checkbox" 
                                            checked={inputs.considerarInflacao}
                                            onChange={(e) => updateInput('considerarInflacao', e.target.checked)}
                                            className="rounded text-emerald-600 focus:ring-emerald-500 w-5 h-5"
                                        />
                                        <span className="text-sm font-medium text-slate-700">Usar Taxa Nominal (Desc. Infla√ß√£o)</span>
                                    </label>
                                    
                                    {inputs.considerarInflacao ? (
                                        <div className="mt-3 animate-fade-in">
                                            <InputGroup 
                                                label="Infla√ß√£o Estimada" 
                                                icon={TrendingDown} 
                                                type="number"
                                                prefix=""
                                                suffix="%"
                                                value={inputs.inflacao} 
                                                onChange={v => updateInput("inflacao", v)} 
                                            />
                                            <p className="text-xs text-slate-500 mt-1">
                                                C√°lculo usando Taxa Nominal - Infla√ß√£o.
                                            </p>
                                        </div>
                                    ) : (
                                        <div className="mt-2 text-xs text-slate-500 space-y-1">
                                            <p className="font-semibold text-slate-700">üí° Modo Juros Reais (Padr√£o)</p>
                                            <p>Ao deixar desmarcado, o simulador mant√©m o <strong>Poder de Compra</strong>.</p>
                                            <p>Ex: R$ 5.000 projetados para daqui 20 anos comprar√£o as mesmas coisas que R$ 5.000 compram hoje.</p>
                                        </div>
                                    )}
                                </div>
                            </Card>
                        </div>

                        {/* RIGHT COLUMN: RESULTS */}
                        <div className="lg:col-span-8 space-y-6">

                            {/* TAB NAVIGATION */}
                            <div className="flex space-x-2 border-b border-gray-200 mb-4">
                                <button
                                    onClick={() => setActiveTab('simulacao')}
                                    className={`pb-2 px-4 font-medium text-sm transition-colors ${activeTab === 'simulacao' ? 'border-b-2 border-emerald-500 text-emerald-700' : 'text-gray-500 hover:text-gray-700'}`}
                                >
                                    Simula√ß√£o Padr√£o
                                </button>
                                <button
                                    onClick={() => setActiveTab('risco')}
                                    className={`pb-2 px-4 font-medium text-sm transition-colors flex items-center gap-2 ${activeTab === 'risco' ? 'border-b-2 border-orange-500 text-orange-700' : 'text-gray-500 hover:text-gray-700'}`}
                                >
                                    <Activity size={16}/>
                                    An√°lise Avan√ßada
                                </button>
                            </div>
                            
                            {activeTab === 'simulacao' ? (
                                <>
                                    {/* KPI GRID */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div className={`p-6 rounded-xl border-l-4 shadow-sm bg-white ${results.sucesso ? 'border-emerald-500' : 'border-red-500'}`}>
                                            <div className="text-sm text-gray-500 uppercase font-semibold">Patrim√¥nio L√≠quido (Financeiro)</div>
                                            <div className="text-3xl font-bold text-gray-800 mt-1">
                                                {formatMoney(results.saldoFinalAcumulacao)}
                                            </div>
                                            <div className="text-sm mt-2 text-gray-600">
                                                Meta necess√°ria: <span className="font-medium">{formatMoney(results.montanteNecessario)}</span>
                                            </div>
                                            <div className={`mt-3 text-sm font-medium ${results.sucesso ? 'text-emerald-600' : 'text-red-600'} flex items-center gap-1`}>
                                                {results.sucesso ? <ShieldCheck size={16}/> : <AlertCircle size={16}/>}
                                                {results.sucesso ? "Meta atingida ‚úÖ" : "Aporte insuficiente ‚ùå"}
                                            </div>
                                        </div>

                                        <div className={`p-6 rounded-xl border-l-4 shadow-sm bg-white ${results.durouTudo ? 'border-emerald-500' : 'border-red-500'}`}>
                                            <div className="text-sm text-gray-500 uppercase font-semibold">Longevidade do Dinheiro</div>
                                            <div className="text-3xl font-bold text-gray-800 mt-1">
                                                {results.durouTudo ? "Vital√≠cio" : `${Math.floor(results.mesFimDinheiro / 12)} anos`}
                                            </div>
                                            <div className="text-sm mt-2 text-gray-600">
                                                Seu dinheiro {results.durouTudo ? "n√£o acaba." : "acaba antes da vida estimada."}
                                            </div>
                                            <div className="mt-3 text-sm text-slate-500 flex items-center gap-1">
                                                <Home size={14}/>
                                                + {formatMoney(results.imobilizado)} em bens (Casa/Carro)
                                            </div>
                                        </div>
                                    </div>

                                    {/* CHART */}
                                    <Card className="h-96">
                                        <h3 className="text-lg font-bold text-slate-700 mb-4 flex justify-between">
                                            Evolu√ß√£o Patrimonial
                                            <span className="text-sm font-normal text-slate-500">
                                                √Årea Verde: Liquidez (Usado para Saque) | √Årea Cinza: Bens
                                            </span>
                                        </h3>
                                        <ResponsiveContainer width="100%" height="100%">
                                            <AreaChart data={results.dadosGrafico} margin={{ top: 10, right: 30, left: 0, bottom: 0 }}>
                                                <defs>
                                                    <linearGradient id="colorLiquido" x1="0" y1="0" x2="0" y2="1">
                                                        <stop offset="5%" stopColor="#10b981" stopOpacity={0.8}/>
                                                        <stop offset="95%" stopColor="#10b981" stopOpacity={0.2}/>
                                                    </linearGradient>
                                                </defs>
                                                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
                                                <XAxis 
                                                    dataKey="ano" 
                                                    tick={{fontSize: 12}}
                                                />
                                                <YAxis 
                                                    tickFormatter={(value) => 
                                                        new Intl.NumberFormat('pt-BR', { notation: "compact", compactDisplay: "short" }).format(value)
                                                    }
                                                    tick={{fontSize: 12}}
                                                    width={60}
                                                />
                                                <Tooltip 
                                                    formatter={(value, name) => {
                                                        if (name === "saldoLiquido") return [formatMoney(value), "Investimentos (L√≠quido)"];
                                                        if (name === "saldoRestrito") return [formatMoney(value), "FGTS/Prev (Bloqueado)"];
                                                        if (name === "saldoImobilizado") return [formatMoney(value), "Bens (Casa/Carro)"];
                                                        if (name === "saldoTotal") return [formatMoney(value), "Patrim√¥nio TOTAL"];
                                                        return [formatMoney(value), name];
                                                    }}
                                                    labelFormatter={(label) => `Ano ${label}`}
                                                    contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }}
                                                />
                                                <ReferenceLine x={inputs.anosAcumulacao} stroke="#f97316" strokeDasharray="3 3" label="Aposentadoria" />
                                                
                                                {/* Stacked Areas para visualiza√ß√£o */}
                                                <Area 
                                                    type="monotone" 
                                                    dataKey="saldoImobilizado" 
                                                    stackId="1" 
                                                    stroke="#94a3b8" 
                                                    fill="#cbd5e1" 
                                                    name="saldoImobilizado"
                                                />
                                                <Area 
                                                    type="monotone" 
                                                    dataKey="saldoRestrito" 
                                                    stackId="1" 
                                                    stroke="#3b82f6" 
                                                    fill="#93c5fd" 
                                                    name="saldoRestrito"
                                                />
                                                <Area 
                                                    type="monotone" 
                                                    dataKey="saldoLiquido" 
                                                    stackId="1" 
                                                    stroke="#10b981" 
                                                    fill="url(#colorLiquido)" 
                                                    name="saldoLiquido"
                                                />
                                            </AreaChart>
                                        </ResponsiveContainer>
                                    </Card>

                                    {/* DETAILS TOGGLE */}
                                    <div className="bg-white rounded-xl border border-gray-200 overflow-hidden">
                                        <button 
                                            onClick={() => setShowDetails(!showDetails)}
                                            className="w-full flex justify-between items-center p-4 bg-gray-50 hover:bg-gray-100 transition-colors"
                                        >
                                            <span className="font-semibold text-gray-700 flex items-center gap-2">
                                                <Calendar className="w-4 h-4"/> Tabela Ano a Ano
                                            </span>
                                            {showDetails ? <ChevronUp size={20}/> : <ChevronDown size={20}/>}
                                        </button>
                                        
                                        {showDetails && (
                                            <div className="overflow-x-auto max-h-96 overflow-y-auto">
                                                <table className="min-w-full text-sm text-left text-gray-500">
                                                    <thead className="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0">
                                                        <tr>
                                                            <th className="px-6 py-3">Ano</th>
                                                            <th className="px-6 py-3">Fase</th>
                                                            <th className="px-6 py-3 text-right">Saldo L√≠quido</th>
                                                            <th className="px-6 py-3 text-right">FGTS/Prev</th>
                                                            <th className="px-6 py-3 text-right">Total Geral</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {results.dadosGrafico.map((row) => (
                                                            <tr key={row.ano} className="bg-white border-b hover:bg-gray-50">
                                                                <td className="px-6 py-4 font-medium text-gray-900">{row.ano}</td>
                                                                <td className="px-6 py-4">
                                                                    <span className={`px-2 py-1 rounded-full text-xs font-semibold ${row.fase === 'Acumula√ß√£o' ? 'bg-emerald-100 text-emerald-800' : 'bg-orange-100 text-orange-800'}`}>
                                                                        {row.fase}
                                                                    </span>
                                                                </td>
                                                                <td className="px-6 py-4 text-right font-mono text-gray-900">
                                                                    {formatMoney(row.saldoLiquido)}
                                                                </td>
                                                                <td className="px-6 py-4 text-right font-mono text-blue-600">
                                                                    {row.saldoRestrito > 0 ? formatMoney(row.saldoRestrito) : '-'}
                                                                </td>
                                                                <td className="px-6 py-4 text-right font-bold text-gray-900">
                                                                    {formatMoney(row.saldoTotal)}
                                                                </td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        )}
                                    </div>
                                </>
                            ) : (
                                <div className="space-y-6 animate-fade-in">
                                    {/* RISK CARD */}
                                    <Card className="border-l-4 border-l-purple-500">
                                        <div className="flex items-start justify-between">
                                            <div>
                                                <h3 className="text-lg font-bold text-gray-800 flex items-center gap-2">
                                                    <Activity className="text-purple-600" />
                                                    Risco de Ru√≠na (Monte Carlo)
                                                </h3>
                                                <p className="text-sm text-gray-600 mt-1 max-w-lg">
                                                    Simulamos 500 cen√°rios poss√≠veis com volatilidade de mercado. Considera apenas o patrim√¥nio financeiro (exclui im√≥veis).
                                                </p>
                                            </div>
                                            <div className="text-right">
                                                <span className={`text-4xl font-bold ${results.riscoRuina < 5 ? 'text-emerald-600' : results.riscoRuina < 15 ? 'text-yellow-600' : 'text-red-600'}`}>
                                                    {results.riscoRuina.toFixed(1)}%
                                                </span>
                                                <p className="text-xs text-gray-500 font-medium uppercase mt-1">Chance de Falha</p>
                                            </div>
                                        </div>
                                        
                                        <div className="mt-4 bg-gray-100 h-3 rounded-full overflow-hidden">
                                            <div 
                                                className={`h-full transition-all duration-500 ${results.riscoRuina < 5 ? 'bg-emerald-500' : results.riscoRuina < 15 ? 'bg-yellow-500' : 'bg-red-500'}`} 
                                                style={{ width: `${Math.min(results.riscoRuina, 100)}%` }}
                                            />
                                        </div>
                                    </Card>

                                    {/* CRISIS CARD */}
                                    <Card className={`border-l-4 ${results.sobreviveuCrise ? 'border-l-blue-500' : 'border-l-red-500'}`}>
                                        <div className="flex items-start gap-4">
                                            <div className={`p-3 rounded-full ${results.sobreviveuCrise ? 'bg-blue-100 text-blue-600' : 'bg-red-100 text-red-600'}`}>
                                                {results.sobreviveuCrise ? <ShieldCheck size={24} /> : <Zap size={24} />}
                                            </div>
                                            <div>
                                                <h3 className="text-lg font-bold text-gray-800">
                                                    Simula√ß√£o de Crise Severa (-30%)
                                                </h3>
                                                <p className="text-sm text-gray-600 mt-1">
                                                    Teste de estresse simulando uma queda de 30% na bolsa no dia exato da sua aposentadoria.
                                                </p>
                                                
                                                <div className={`mt-4 p-4 rounded-lg border ${results.sobreviveuCrise ? 'bg-blue-50 border-blue-100' : 'bg-red-50 border-red-100'}`}>
                                                    <p className={`font-semibold ${results.sobreviveuCrise ? 'text-blue-800' : 'text-red-800'}`}>
                                                        {results.sobreviveuCrise 
                                                            ? "‚úÖ O plano sobrevive." 
                                                            : "‚ùå O dinheiro acaba antes do fim."}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </Card>

                                    <div className="bg-yellow-50 border border-yellow-200 p-4 rounded-lg flex gap-3 text-sm text-yellow-800">
                                        <AlertTriangle className="flex-shrink-0" size={20} />
                                        <p>
                                            <strong>Nota:</strong> Estas s√£o simula√ß√µes matem√°ticas. O FGTS/Previd√™ncia √© considerado como "injeta√ß√£o de liquidez" no primeiro ano da aposentadoria. Im√≥veis n√£o entram no c√°lculo de risco.
                                        </p>
                                    </div>
                                </div>
                            )}

                        </div>
                    </div>
                </div>
            );
        }

        // --- INICIALIZA√á√ÉO ---
        const root = createRoot(document.getElementById('root'));
        root.render(<FinancialPlanner />);
    </script>
</body>
</html>
